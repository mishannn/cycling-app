"use strict";(self.webpackChunkcycling_app=self.webpackChunkcycling_app||[]).push([[344],{344:(e,t,i)=>{i.r(t),i.d(t,{BluetoothLeWeb:()=>s});var a=i(403),n=i(402);class s extends a.E_{constructor(){super(...arguments),this.deviceMap=new Map,this.discoveredDevices=new Map,this.scan=null,this.DEFAULT_CONNECTION_TIMEOUT=1e4,this.onAdvertisementReceivedCallback=this.onAdvertisementReceived.bind(this),this.onDisconnectedCallback=this.onDisconnected.bind(this),this.onCharacteristicValueChangedCallback=this.onCharacteristicValueChanged.bind(this)}async initialize(){if("undefined"===typeof navigator||!navigator.bluetooth)throw this.unavailable("Web Bluetooth API not available in this browser.");if(!await navigator.bluetooth.getAvailability())throw this.unavailable("No Bluetooth radio available.")}async isEnabled(){return{value:!0}}async requestEnable(){throw this.unavailable("requestEnable is not available on web.")}async enable(){throw this.unavailable("enable is not available on web.")}async disable(){throw this.unavailable("disable is not available on web.")}async startEnabledNotifications(){}async stopEnabledNotifications(){}async isLocationEnabled(){throw this.unavailable("isLocationEnabled is not available on web.")}async openLocationSettings(){throw this.unavailable("openLocationSettings is not available on web.")}async openBluetoothSettings(){throw this.unavailable("openBluetoothSettings is not available on web.")}async openAppSettings(){throw this.unavailable("openAppSettings is not available on web.")}async setDisplayStrings(){}async requestDevice(e){const t=this.getFilters(e),i=await navigator.bluetooth.requestDevice({filters:t.length?t:void 0,optionalServices:null===e||void 0===e?void 0:e.optionalServices,acceptAllDevices:0===t.length});this.deviceMap.set(i.id,i);return this.getBleDevice(i)}async requestLEScan(e){this.requestBleDeviceOptions=e;const t=this.getFilters(e);await this.stopLEScan(),this.discoveredDevices=new Map,navigator.bluetooth.removeEventListener("advertisementreceived",this.onAdvertisementReceivedCallback),navigator.bluetooth.addEventListener("advertisementreceived",this.onAdvertisementReceivedCallback),this.scan=await navigator.bluetooth.requestLEScan({filters:t.length?t:void 0,acceptAllAdvertisements:0===t.length,keepRepeatedDevices:null===e||void 0===e?void 0:e.allowDuplicates})}onAdvertisementReceived(e){var t,i,a;const s=e.device.id;this.deviceMap.set(s,e.device);const o=!this.discoveredDevices.has(s);if((!(null===(t=this.requestBleDeviceOptions)||void 0===t?void 0:t.serviceData)||this.matchesServiceDataFilter(e))&&(o||(null===(i=this.requestBleDeviceOptions)||void 0===i?void 0:i.allowDuplicates))){this.discoveredDevices.set(s,!0);const t=this.getBleDevice(e.device),i={device:t,localName:t.name,rssi:e.rssi,txPower:e.txPower,manufacturerData:(0,n.Li)(e.manufacturerData),serviceData:(0,n.Li)(e.serviceData),uuids:null===(a=e.uuids)||void 0===a?void 0:a.map(n.AG)};this.notifyListeners("onScanResult",i)}}async stopLEScan(){var e;(null===(e=this.scan)||void 0===e?void 0:e.active)&&this.scan.stop(),this.scan=null}async getDevices(e){return{devices:(await navigator.bluetooth.getDevices()).filter((t=>e.deviceIds.includes(t.id))).map((e=>{this.deviceMap.set(e.id,e);return this.getBleDevice(e)}))}}async getConnectedDevices(e){return{devices:(await navigator.bluetooth.getDevices()).filter((e=>{var t;return null===(t=e.gatt)||void 0===t?void 0:t.connected})).map((e=>{this.deviceMap.set(e.id,e);return this.getBleDevice(e)}))}}async getBondedDevices(){return{}}async connect(e){var t,i;const a=this.getDeviceFromMap(e.deviceId);a.removeEventListener("gattserverdisconnected",this.onDisconnectedCallback),a.addEventListener("gattserverdisconnected",this.onDisconnectedCallback);const n=Symbol();if(void 0===a.gatt)throw new Error("No gatt server available.");try{const i=null!==(t=e.timeout)&&void 0!==t?t:this.DEFAULT_CONNECTION_TIMEOUT;await async function(e,t,i){let a;return Promise.race([e,new Promise(((e,n)=>{a=setTimeout((()=>n(i)),t)}))]).finally((()=>clearTimeout(a)))}(a.gatt.connect(),i,n)}catch(s){throw await(null===(i=a.gatt)||void 0===i?void 0:i.disconnect()),s===n?new Error("Connection timeout"):s}}onDisconnected(e){const t=`disconnected|${e.target.id}`;this.notifyListeners(t,null)}async createBond(e){throw this.unavailable("createBond is not available on web.")}async isBonded(e){throw this.unavailable("isBonded is not available on web.")}async disconnect(e){var t;null===(t=this.getDeviceFromMap(e.deviceId).gatt)||void 0===t||t.disconnect()}async getServices(e){var t,i;const a=null!==(i=await(null===(t=this.getDeviceFromMap(e.deviceId).gatt)||void 0===t?void 0:t.getPrimaryServices()))&&void 0!==i?i:[],n=[];for(const s of a){const e=await s.getCharacteristics(),t=[];for(const i of e)t.push({uuid:i.uuid,properties:this.getProperties(i),descriptors:await this.getDescriptors(i)});n.push({uuid:s.uuid,characteristics:t})}return{services:n}}async getDescriptors(e){try{return(await e.getDescriptors()).map((e=>({uuid:e.uuid})))}catch(t){return[]}}getProperties(e){return{broadcast:e.properties.broadcast,read:e.properties.read,writeWithoutResponse:e.properties.writeWithoutResponse,write:e.properties.write,notify:e.properties.notify,indicate:e.properties.indicate,authenticatedSignedWrites:e.properties.authenticatedSignedWrites,reliableWrite:e.properties.reliableWrite,writableAuxiliaries:e.properties.writableAuxiliaries}}async getCharacteristic(e){var t;const i=await(null===(t=this.getDeviceFromMap(e.deviceId).gatt)||void 0===t?void 0:t.getPrimaryService(null===e||void 0===e?void 0:e.service));return null===i||void 0===i?void 0:i.getCharacteristic(null===e||void 0===e?void 0:e.characteristic)}async getDescriptor(e){const t=await this.getCharacteristic(e);return null===t||void 0===t?void 0:t.getDescriptor(null===e||void 0===e?void 0:e.descriptor)}async discoverServices(e){throw this.unavailable("discoverServices is not available on web.")}async getMtu(e){throw this.unavailable("getMtu is not available on web.")}async requestConnectionPriority(e){throw this.unavailable("requestConnectionPriority is not available on web.")}async readRssi(e){throw this.unavailable("readRssi is not available on web.")}async read(e){const t=await this.getCharacteristic(e);return{value:await(null===t||void 0===t?void 0:t.readValue())}}async write(e){const t=await this.getCharacteristic(e);let i;i="string"===typeof e.value?(0,n.BR)(e.value):e.value,await(null===t||void 0===t?void 0:t.writeValueWithResponse((0,n.I2)(i)))}async writeWithoutResponse(e){const t=await this.getCharacteristic(e);let i;i="string"===typeof e.value?(0,n.BR)(e.value):e.value,await(null===t||void 0===t?void 0:t.writeValueWithoutResponse((0,n.I2)(i)))}async readDescriptor(e){const t=await this.getDescriptor(e);return{value:await(null===t||void 0===t?void 0:t.readValue())}}async writeDescriptor(e){const t=await this.getDescriptor(e);let i;i="string"===typeof e.value?(0,n.BR)(e.value):e.value,await(null===t||void 0===t?void 0:t.writeValue((0,n.I2)(i)))}async startNotifications(e){const t=await this.getCharacteristic(e);null===t||void 0===t||t.removeEventListener("characteristicvaluechanged",this.onCharacteristicValueChangedCallback),null===t||void 0===t||t.addEventListener("characteristicvaluechanged",this.onCharacteristicValueChangedCallback),await(null===t||void 0===t?void 0:t.startNotifications())}onCharacteristicValueChanged(e){var t,i;const a=e.target,n=`notification|${null===(t=a.service)||void 0===t?void 0:t.device.id}|${null===(i=a.service)||void 0===i?void 0:i.uuid}|${a.uuid}`;this.notifyListeners(n,{value:a.value})}async stopNotifications(e){const t=await this.getCharacteristic(e);await(null===t||void 0===t?void 0:t.stopNotifications())}getFilters(e){var t,i;const a=[];for(const n of null!==(t=null===e||void 0===e?void 0:e.services)&&void 0!==t?t:[])a.push({services:[n],name:null===e||void 0===e?void 0:e.name,namePrefix:null===e||void 0===e?void 0:e.namePrefix});((null===e||void 0===e?void 0:e.name)||(null===e||void 0===e?void 0:e.namePrefix))&&0===a.length&&a.push({name:e.name,namePrefix:e.namePrefix});for(const n of null!==(i=null===e||void 0===e?void 0:e.manufacturerData)&&void 0!==i?i:[])a.push({manufacturerData:[n]});return a}matchesServiceDataFilter(e){var t;const i=null===(t=this.requestBleDeviceOptions)||void 0===t?void 0:t.serviceData;if(!i||0===i.length)return!0;if(!e.serviceData)return!1;for(const a of i){const t=e.serviceData.get(a.serviceUuid);if(!t)continue;if(!a.dataPrefix)return!0;const i=new Uint8Array(t.buffer),n=a.dataPrefix;if(!(i.length<n.byteLength))if(a.mask){const e=a.mask;let t=!0;for(let a=0;a<n.byteLength;a++)if((i[a]&e.getUint8(a))!==(n.getUint8(a)&e.getUint8(a))){t=!1;break}if(t)return!0}else{let e=!0;for(let t=0;t<n.byteLength;t++)if(i[t]!==n.getUint8(t)){e=!1;break}if(e)return!0}}return!1}getDeviceFromMap(e){const t=this.deviceMap.get(e);if(void 0===t)throw new Error('Device not found. Call "requestDevice", "requestLEScan" or "getDevices" first.');return t}getBleDevice(e){var t;return{deviceId:e.id,name:null!==(t=e.name)&&void 0!==t?t:void 0}}}}}]);
//# sourceMappingURL=344.274add5a.chunk.js.map